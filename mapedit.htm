<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<link REL="SHORTCUT ICON" HREF="mapscholaricon.ico">
	<title>MapScholar Editor</title>
 	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>	
	<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
	<script src="//www.qmediaplayer.com/qfile.js"></script>
	<script src="ckeditor/ckeditor.js"></script>

	<style type="text/css">
		body { 			font-family:Verdana,Geneva,sans-serif; font-size:10px;}
		.rounded-corners { -moz-border-radius:8px;-webkit-border-radius:8px;-khtml-border-radius:8px;border-radius:8px;}
		tr.odd { 		background-color:#e0e0e0; }
		td:focus {		outline:none;	}
		select:focus {	outline:none;	}
		.ui-autocomplete { max-height: 300px; overflow-y: auto; }
	
 		.unselectable { -moz-user-select: none;     -khtml-user-select: none;
		   			 	-webkit-user-select: none;  -ms-user-select: none;   user-select: none;
		   				}
 	 	.player { 		display:inline-block;margin:0px;border:none;padding:0px;
 	 					}
	 	.pane 	{ 		background-color:#f0f0f0;font-size:12px
	 					}
	 	.footer { 		margin:-1px;border-bottom-right-radius:4px;border-bottom-left-radius:4px; 
	 					border:1px solid #999;background-color:#ddd;font-size:13px;
	 					padding:0px;padding-top:4px;padding-bottom:4px;
	 					display:inline-block;top:100%;width:100%;
	 					}
	 	.editor { 		border-radius:4px;border:1px solid #999;min-width:400px;
	 					}
		.butSty {		border-radius:10px;color:#333;cursor:pointer;
						}
 		.ui-menu {     	overflow:hidden;border:none;font-size:13px;
 						border-radius:0px;border-bottom:1px solid #999;padding:0px !important;
 						}
		.ui-menu > li { 				float: left;display: block;width: auto !important;}
		.ui-menu ul {   				border:1px solid #999;border-radius:4px;padding-bottom:6px !important;}
		.ui-menu ul li {   				display:block;float:none;border:none }
		.ui-menu ul li ul {    			width:auto; left:96px !important; padding-top:5px !important;padding-bottom:5px !important;}
		.ui-menu ul li ul li {    		width:auto !important; margin: 0px 5px !important; }
		.ui-menu ul li ul li a {   	 	float:left; }
		.ui-menu li {    				margin: 5px 5px !important; padding: 0 0 !important; }
		.ui-menu > li > a {  			float:left;display:block;clear: both;overflow: hidden; }
		.ui-menu .ui-menu-icon {     	display:none }
		.ui-menu .ui-menu .ui-menu li { float:left;display:block; }	
 		.ui-menu .ui-menu { 		    overflow: visible !important; }
		.bs {			border-radius:10px;padding-left:8px;padding-right:8px;padding-top:1px;
						border:1px solid #999;font-size:12px;height;20px;cursor:pointer;
						}
		.is {			border-radius:10px;padding-left:8px;padding-right:8px;padding-top:1px;
						border:1px solid #999;font-size:12px;height:16px;width:200px;
						}

 	</style>
</head>

	<div id='playerDiv' class='unselectable' style='margin-top:-12px;margin-left:-12px'>
		<iframe class="player" id="playerIF" src="index.htm" scrolling="no"></iframe>
	</div>
	<div id="editDiv" class="editor unselectable" style="position:absolute;top:16px;z-index:4;display:hidden"> 
		 <ul id="menu" style="margin:1px">
		    <li id=""><a href="#">File</a><ul>
				<li id="m11"><a  href="#">New</a></li>
				<li id="m12"><a href="#">Open</a></li>
				<li id="m13"><a href="#">Save</a></li>
				<li id="m14"><a href="#">Save As...</a></li>
				<li id="m15"><a href="#">Delete</a></li>
				<li id="m16"><a href="#">Undelete</a></li>
		   	</ul></li>
		    <li id=""><a href="#">Edit</a><ul>
				<li id="m21"><a href="#">Undo</a></li>
	            <li id="m22"><a href="#">Bookmark&nbsp;an&nbsp;undo</a></li>
		 		<li id="m23"><a href="#">JSON</a></il>
		   	</ul></li>
			    <li id=""><a href="#">Content</a><ul>
				<li id="m31"><a href="#">Edit mobs</a></li>
	 			<li id="m32"><a href="#">Edit pages</a></li>
		   </ul></li>
		</ul>
		<div id="paneDiv" class="pane" style="width:100%;height:100%;"></div> 
		<div id="footerDiv" class="footer" style="position:absolute;width:100%">
			<span id="showName"></span>
			<a id='getHelp' href='https://docs.google.com/document/d/11aS861HLnwg9IQ8JJe4UZ-GZ20980Va2kTmfHYHPd0A/edit?usp=sharing' 
				target='_blank' style='text-decoration:none;position:absolute'>
				<img src="img/helpicon.gif"></a>
		</div>
	</div>
	<div id="playerSiz" style="position:absolute;top:0px;width:8px;cursor:col-resize;opacity:inherit;height:100%;z-index:100" class="unselectable" title="Resize player"></div>
		
<body>
<script>

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
	var playerWid=1150;
	var curShow="None";															// Currently loaded show name
	var curPane="intro";														// Current edit pane
	var curJson={ };															// Holds current JSON
	var qmf=null;																// File system
	var butsty=" style='border-radius:10px;color#666;padding-left:12px;padding-right:12px;color:#222;background-color:#ccc;font-size:12px;' ";	// Button styling
	var keyFlag="";																// Holds key flags												
	var playerZoom=1;															// Zoom
	var curPos;																	// Current earth locale
	var curEdit=0;
	
	$(document).ready(function() {											// WHEN PAGE LOADED
		if (window.addEventListener) 											// If supported this way
			window.addEventListener("message",shivaEventHandler,false);			// Add event handler
		else																	// Use other method
			window.attachEvent("message",shivaEventHandler);					// Add handler

		qmf=new QmediaFile("//qmediaplayer.com/",1);							// Alloc file system
		NewShow();																// Init show
		
		var url=window.location.search.substring(1);							// Get query string
		if (url && url.match(/ge=/)) 											// If tagged to use Google Earth
			$("#playerIF").prop("src","index.htm?ge=1");						// Reset to GE map
		
		var w=$(window).width();												// Get window width
		if (w < playerWid+500)													// If too small
			playerZoom=(w-500)/playerWid;
	
		sessionStorage.clear();													// Reset undos
		$("#menu" ).menu({ position:{my:"left top", at: "left top+40" }});		// Set menu
		$("#menu").on("menuselect", function(event,ui) { 						// On menu select
				qmf.xPos=$("#paneDiv").offset().left+8;							// Set pos of popup dialogs
				var id=ui.item[0].id.substr(1);									// Get id
				if (id)	Sound("click");											// Click
				switch(id) {													// Route on id
					case "11":	ConfirmBox("This will clear the project you current have open. It will not affect the one stored online",NewShow);
								ChangePane("intro");	Preview();		break;	// New file
					case "12":	ChangePane("intro");	qmf.Load(); 	break;	// Load file
					case "13":	ChangePane("intro");	qmf.Save(0); 	break;	// Save file
					case "14":	ChangePane("intro");	qmf.Save(1); 	break;	// Save as... 
					case "15":	ChangePane("intro");	qmf.Delete(); 	break;	// Delete
					case "16":	ChangePane("intro");	qmf.Delete(1); 	break;	// Undelete
					case "21":	Undo();									break;	// Undo
					case "22":	Do("bookmark");							break;	// Save bookmark
					case "23":	ChangePane("json");						break;	// Edit JSON
					case "23":	ChangePane("html");						break;	// Edit HTML
					case "31":	ChangePane("editmobs");					break;	// Edit mobs
					case "32": 	ChangePane("editpages");  				break;	// Edit pages 
					}
			 	});
		
		Draw();
		$(window).resize(function(e) { if (!e.target.id) Draw();	 } );		// Redraw on window resize		
		$("#editDiv").show();													// Show editor

		$("#playerSiz").draggable({												// DRAG PLAYER WIDTH HANDLER
			cursorAt:{left:-8},iframeFix:true,									// Cursor offset
			cursor: "col-resize", axis:"x",										// X-only
			stop: function(event, ui) {	Draw(); },								// On stop resize panes
			drag: function(event, ui) {											// On drag
			 	playerZoom=Math.max(0,Math.min(1,(event.clientX)/playerWid));	// Set ratio between windows
				Draw();															// Resize panes
				}
			});
		$("#playerSiz").hover(													// Player width
			function(){ $(this).css("background-color","#acc3db")},				// Highlight
			function(){ $(this).css("background-color","transparent")			// Hide
		});

	});	
	
	function NewShow() 														// NEW SHOW
	{	
		curShow=qmf.curFile="";													// Clear curshow
		curJson=[ { "id": 0, "type": "startup", "title": "Untitled" } ];		// Add startup mob
 		Preview();																// Preview
		Draw();																	// Show curshow number as vlanml
	}

	function LoadShow(data)													// LOAD A SHOW
	{
 		if (data.qmfmsg == "private") {											// If a private file		
			AlertBox("Private project","Sorry, but this project is marked <i>private</i>. You will need to supply the password to load it");
			return;																// Quit
			}
		else if (data.qmfmsg == "error") {										// If an error
			AlertBox("Sorry, but there was an error loading this project");
			return;																// Quit
			}
 		curJson=data;															// Set json
   		if (qmf.curFile)														// If a good file
   			curShow=qmf.curFile;												// Set curshow
  		Preview(); 																// Preview show
  		ChangePane("editmobs");													// Edit mobs 		
   		Draw();																	// Redraw 
   		Sound('ding'); 															// Ding
    	}

	function Preview()														// PREVIEW SHOW
	{
		Do();																	// Save for undo
		if (curPane == "settings") 												// If current pane Settings
			Draw();																// Redraw frame because width may be reset
		Sound("click");															// Click
		SendShivaMessage("MapEdit=data",JSON.stringify(curJson));				// Send to show player	   		
    	}
   	  	
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// EDIT PANES
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function ChangePane(newPane) 											// CHANGE EDIT PANE
	{	
		if (curPane == "json") {												// If current pane is JSON editor
			var str=$("#jsonEditor").val();										// Get script
			try {																// Try this
				curJson=$.parseJSON(str);  										// Get editor contents
				}
			catch(err) {														// On error	
				AlertBox("JSON syntax error", "There is some error in this JSON. Any edits made will be ignored.");	
				}
			}
		curPane=newPane;														// Set current pane
		Draw();																	// Redraw
	}
	
	function Draw()															// RESIZE PANES
	{ 
		var str;
		var wid=playerWid;														// Copy width
		var w=window.innerWidth-(wid*playerZoom)-16;							// Editor width
		var h=Math.max(window.innerHeight-64,650);								// Editor height
		$("#playerIF").prop("width",wid);										// Player wid
		$("#playerIF").prop("height",h);										// Hgt
		$("#editDiv").css({width:w+"px",left:wid*playerZoom+6+"px",height:h-8+"px"}); // Overall div
		$("#getHelp").css({left:w-24+"px"});									// Help dot to right
	
		$("#showName").html("&nbsp; Current show: <b>"+curShow+"</b>");			// Show name
		if (curPane == "json") {												// Editing pane
			str="<textarea id='jsonEditor' style='width:"+(w-32)+"px;height:"+(h-55)+"px;border:none;font-size:13px;padding:16px;background-color:#f8f8f8'>"+JSON.stringify(curJson,null,'\t')+"</textarea></div>";
			$("#paneDiv").html(str);											// Put editor up	
			}
		else if (curPane == "intro") {											// Startup pane
			str="<br><br><p style='text-align:center'><img src='img/MapScholarLogo.png'></p>";	// Image
			$("#paneDiv").html(str);											// Put editor up	
			}
		else if (curPane == "editmobs")  	MobEditPane();						// Mob edit pane
		else if (curPane == "editpages")  	PageEditPane();						// Page edit pane

		$("#playerDiv").css({	"-webkit-transform-origin":"0 0", 				// Scale player window
				"transform-origin":"0 0",			
				"-webkit-transform":"matrix("+playerZoom+",0,0,"+playerZoom+",0,0)",
	 			"-transform":"matrix("+playerZoom+",0,0,"+playerZoom+",0,0)",
	   			});
		$("#playerSiz").css({ left:(playerWid*playerZoom-3)+"px"});				// Set sizer pos
	}

//////////////////////////////////////////// PAGE EDIT ///////////////////////////////////////////////

	function PageEditPane()													// PAGE EDITOR
	{
		var h=$("#paneDiv").height()-220;										// Max height
		var str="<div style='padding:12px'><br>"									// Container div
		str+="<div style='display:inline-block;font-size:36px;color:#999'><b>Edit pages</div>";
		str+="<br><br><div style='max-height:"+h+"px;overflow-x:hidden;overflow-y:auto;background-color:#f8f8f8;padding:8px;border:1px solid #999;border-radius:8px'>";		// Scrollable container
		str+="<table id='contentTable' style='font-size:12px;width:100%;padding:0px;border-collapse:collapse;'>";	// Add table
		str+="</table></div><div style='font-size:12px'<br><br>";				// End table
		str+="<button"+butsty+"id='addPageBut'>Add a new page</button>";		// Add button
		str+="&nbsp;&nbsp;<button"+butsty+"onclick='Preview()'>Preview</button>";		// Preview button
		$("#paneDiv").html(str+"</div>");										// Put editor up	
		MakePageTable();														// Make table

		$("#addPageBut").on("click",function() {								// ON ADD
			var i,lastPage=-1;
			var o={};															// New obj
			for (i=0;i<curJson.length;++i) 										// For each mob
				if (curJson[i].type == "page")									// If a page
					lastPage=i;													// Mark as last page
			o.id=Math.floor(Math.random()*9999);								// Make up id
			o.type="page";														// Assume chapter
			o.title="Untitled"													// No title
			curJson.push(o)														// Add startup mob
			MakePageTable();													// Remake table
			Sound("click");														// Click
			if (lastPage != -1)													// If already pages there
				onMoveMob(curJson.length-1,lastPage+1);							// Move to end of them
			
			});

		}

	function MakePageTable() 												// MAKE PAGE TABLE
	{	
		var i,o; 
		var	pic="images/pageicon.jpg";											// Use icon
		var trsty=" style='background-color:#f8f8f8' onMouseOver='this.style.backgroundColor=\"#dee7f1\"' ";
		trsty+="onMouseOut='this.style.backgroundColor=\"#f8f8f8\"'";
		$("#contentTable").empty();												// Remove all rows
		for (i=0;i<curJson.length;++i) {														// For each index
			o=curJson[i];														// Point at row
			if (o.type != "page") 												// If a page
				continue;														// Dont show
			str="<tr id='idx"+i+"' "+trsty+">";									// Row
			str+="<td style='width:115px;vertical-align:top'><img style='border:1px solid #999' height='64' width='100' src='"+pic+"'></td>";	// Add thumbnail
			str+="<td><div style='display:inline-block;width:45px;color:#777;vertical-align:5px'><b>Title:</b></div>";
			str+="<textarea class='is' rows='1' style='width:204px;vertical-align:bottom;height:15px;margin-bottom:2px' id='idt"+i+"'>"+(o.title ? o.title : '')+"</textarea>";
			str+=" <img src='img/editdot.gif' id='idth"+i+"'>";
			str+="<br><div style='display:inline-block;width:45px;color:#777;vertical-align:4px'><b>Desc:</b></div>";
			str+="<textarea class='is' rows='1' style='width:204px;vertical-align:bottom;height:15px;margin-bottom:2px' id='idd"+i+"'>"+(o.desc ? o.desc : '')+"</textarea>";
			str+=" <img src='img/editdot.gif' id='iddh"+i+"'>";
			str+="<br><div style='display:inline-block;width:45px;color:#777'><b>ID:</b></div>";
			str+="<input class='is' style='width:30px' type='text' id='idi"+i+"' value='"+(o.id != undefined ? o.id : '')+"'>";
			str+=" &nbsp; <button class='bs' style='color:#009900;background-color:#fff;' id='idg"+i+"'>"+(o.goto ? 'Set goto' : 'Add goto')+"</button>";

			str+="</td><td><img style='visibility:hidden' id='idtm"+i+"' src='images/movedot.gif'>";	// Add move icon
			str+="<br><br><img style='visibility:hidden' id='idtr"+i+"' src='images/trashdot.gif' onclick='onDeleteMob(this.id)'></td>"; // Add trashcan
			if (i < curJson.length-1) 											// If not last line
				str+="</tr><tr><td colspan='3'><hr></td></tr>";					// Add between line
			$("#contentTable").append(str);										// Add row
			
			$("#idx"+i).on("click", function(e) {								// ON ROW CLICK
					var id=e.currentTarget.id.substr(3);						// Extract id
					if (id == undefined)										// If deselecting
						return;													// Quit
					SendShivaMessage("MapEdit=mob",id);							// Go to this mob	   		
 					Sound("click");												// Click
						for (var j=0;j<curJson.length;++j) {					// For each mob
						$("#idtm"+j).css({"visibility":"hidden"});				// Hide move icons
						$("#idtr"+j).css({"visibility":"hidden"});				// Hide trashcans
						$("#idx"+j).droppable({ drop: function(event, ui) {		// On drop
 							Sound("click");										// Click
							onMoveMob(id,event.target.id.substr(3));			// Move it				
							MakePageTable();									// Remake table
							}});
						}
					$("#idtm"+id).css({"visibility":"visible"});				// Show this move icon
					$("#idtr"+id).css({"visibility":"visible"});				// Show this trashcan
					$("#idtm"+id).draggable({ axis:"y"});						// Make icon draggable
					});														

			$("#idth"+i).on("click", function() {								// HTML EDITOR
					var id=this.id.substr(4);									// Get id
					HTMLEditor(id, curJson[id].title, function(d) {				// Edit text
						curJson[id].title=d;									// Set val
						MakePageTable();										// Remake table
						});
					});				

			$("#iddh"+i).on("click", function() {								// HTML EDITOR
					var id=this.id.substr(4);									// Get id
					HTMLEditor(id, curJson[id].desc, function(d) {				// Edit text
						curJson[id].desc=d;										// Set val
						MakePageTable();										// Remake table
						});
					});				

			$("#idt"+i).on("blur", function() {									// ON BLUR OF TITLE
					var id=this.id.substr(3);									// Get id
					curJson[id].title=$("#idt"+id).val();						// Get text
					MakePageTable();											// Remake table
					});				

			$("#idi"+i).on("blur", function() {									// ON BLUR OF ID
					var id=this.id.substr(3);									// Get id
					curJson[id].id=$("#idi"+id).val();							// Get text
					MakePageTable();											// Remake table
					});				
			
			$("#idd"+i).on("blur", function() {									// ON BLUR OF DESC
					var id=this.id.substr(3);									// Get id
					curJson[id].desc=$("#idd"+id).val();						// Get text
					MakePageTable();											// Remake table
					});				

			$("#idg"+i).on("click", function() {								// GOTO EDITOR
					var id=this.id.substr(3);									// Get id
					GoToEditor(id, curJson[id].goto, function(w) {				// Edit source
						curJson[id].goto=w;										// Set val
						MakePageTable();										// Show
						});
					});				
		}																	// End mob loop
	}	

	
//////////////////////////////////////////// MOB EDIT ///////////////////////////////////////////////


	function MobEditPane()													// MOB EDITOR
	{
		var h=$("#paneDiv").height()-220;										// Max height
		var str="<div style='padding:12px'><br>"								// Container div
		str+="<div style='display:inline-block;font-size:36px;color:#999'><b>Edit mobs</div>";
		str+="<br><br><div id='mobList' style='max-height:"+h+"px;overflow-x:hidden;overflow-y:auto;background-color:#f8f8f8;padding:8px;border:1px solid #999;border-radius:8px'>";		// Scrollable container
		str+="<table id='contentTable' style='font-size:12px;width:100%;padding:0px;border-collapse:collapse;'>";	// Add table
		str+="</table></div><div style='font-size:12px'<br><br>";				// End table
		str+="<button"+butsty+"id='addMobBut'>Add a new mob</button>";			// Add button
		str+="&nbsp;&nbsp;<button"+butsty+"onclick='Preview()'>Preview</button>";		// Preview button
		$("#paneDiv").html(str+"</div>");										// Put editor up	
		curEdit=0;																// Start at top
		MakeMobTable();															// Make table

		$("#addMobBut").on("click",function() {									// ON ADD
			var o={};															// New obj
			o.id=Math.floor(Math.random()*9999);								// Make up id
			o.type="text";														// Assume chapter
			o.title="Untitled"													// No title
			curJson.push(o)														// Add startup mob
			var id=curEdit-0+1;													// Point to new mob
			curJson.splice(id,0,curJson.splice(curJson.length-1,1)[0]);			// Move		
			MakeMobTable();														// Remake table
			Sound("click");														// Click
			HighlightMob(id);													// Highlight it in list
			});
		}

	function MakeMobTable() 												// MAKE TABLE
	{	
		var i,o,pic; 
		var trsty=" style='height:20px;background-color:#f8f8f8' onMouseOver='this.style.backgroundColor=\"#dee7f1\"' ";
		trsty+="onMouseOut='this.style.backgroundColor=\"#f8f8f8\"'";
		$("#contentTable").empty();												// Remove all rows
		for (i=0;i<curJson.length;++i) {														// For each index
			o=curJson[i];														// Point at row
			if (o.type == "page") 												// If a page
				continue;														// Dont show
			str="<tr id='idx"+i+"' "+trsty+">";									// Row
			if (o.type == "map") {												// If a map
				if (o.small)                                                    // If a small defined															
					pic=o.small;												// Use it
				else if (o.med)													// Else if a med defined															
					pic=o.med;													// Use it
				else if (o.url)													// Else if a large defined															
					pic=o.url;													// Use it
				else															// Else
					pic="images/mobicon.jpg";									// Use icon
				}
			else if ((o.type == "chapter") || (o.type == "header")) 			// If a chapter or header
				pic="images/chaptericon.png";									// Use icon
			else if (o.type == "startup") 										// If a startup
				pic="images/starticon.jpg";										// Use icon
			else if (o.type == "choro") 										// If a choro
				pic="images/choroicon.jpg";										// Use icon
			else if (o.type == "goto") 											// If a goto
				pic="images/goto.jpg";											// Use icon
			else if (o.type == "info") 											// If as info
				pic="images/infoicon.jpg";										// Use icon
			else if (o.type == "link") 											// If a link
				pic="images/linkicon.jpg";										// Use icon
			else if (o.type == "layer") 										// If a layer
				pic="images/layericon.png";										// Use icon
			else if (o.type == "sound") 										// If a layer
				pic="images/soundicon.jpg";										// Use icon
			else
				pic="images/mobicon.jpg";										// Use icon
			str+="<td style='width:115px;vertical-align:top'><img style='border:1px solid #999' height='60' width='100' src='"+pic+"'></td>";	// Add thumbnail
			str+="<td style='vertical-align:top;white-space:nowrap'><div style='display:inline-block;width:45px;color:#777'><b>Type: </b></div>";
			str+=MakeSelect("ida"+i,false,["chapter","choro", "goto","header","info","layer","link","map","sound","startup","text"],o.type);	
			str+=" &nbsp; <button class='bs' style='color:#009900;background-color:#fff' id='idg"+i+"'>"+(o.goto ? 'Set goto' : 'Add goto')+"</button> &nbsp; ";
			str+="<button class='bs' style='color:#009900;background-color:#fff' id='idm"+i+"'>More...</button>";
			str+="<br><div style='display:inline-block;width:45px;color:#777;vertical-align:4px'><b>Title:</b></div>";
			str+="<textarea class='is' rows='1' style='width:214px;vertical-align:bottom;height:15px;margin-top:2px' type='text' id='idt"+i+"'>"+(o.title ? o.title : '')+"</textarea>";
			str+=" <img src='img/editdot.gif' id='idth"+i+"'>";
			str+="<br><div style='display:inline-block;width:45px;color:#777;vertical-align:4px'><b>Desc:</b></div>";
			str+="<textarea class='is' rows='1' style='width:214px;vertical-align:bottom;height:15px;margin-top:2px' type='text' id='idd"+i+"'>"+(o.desc ? o.desc : '')+"</textarea>";
			str+=" <img src='img/editdot.gif' id='iddh"+i+"'>";
			str+="</td><td><img style='visibility:hidden' id='idtm"+i+"' src='images/movedot.gif'>";	// Add move icon
			str+="<br><br><img style='visibility:hidden' id='idtr"+i+"' src='images/trashdot.gif' onclick='onDeleteMob(this.id)'></td>"; // Add trashcan
			if (i < curJson.length-1) 											// If not last line
				str+="</tr><tr><td colspan='3'><hr></td></tr>";					// Add between line
			$("#contentTable").append(str);										// Add row
			
			$("#idx"+i).on("click", function(e) {								// ON ROW CLICK
					var id=e.currentTarget.id.substr(3);						// Extract id
					if (id == undefined)										// If deselecting
						return;													// Quit
					curEdit=id;													// This is current edit
					SendShivaMessage("MapEdit=mob",id);							// Go to this mob	   		
 					Sound("click");												// Click
					for (var j=0;j<curJson.length;++j) {						// For each mob
						$("#idtm"+j).css({"visibility":"hidden"});				// Hide move icons
						$("#idtr"+j).css({"visibility":"hidden"});				// Hide trashcans
						$("#idx"+j).droppable({ drop: function(event, ui) {		// On drop
  							Sound("ding");										// Ding
							onMoveMob(id,event.target.id.substr(3));			// Move it				
							MakeMobTable();										// Remake table
							}});
						}
					$("#idtm"+id).css({"visibility":"visible"});				// Show this move icon
					$("#idtr"+id).css({"visibility":"visible"});				// Show this trashcan
					$("#idtm"+id).draggable({ axis:"y"});						// Make icon draggable
					});														

			$("#idth"+i).on("click", function() {								// HTML EDITOR
					var id=this.id.substr(4);									// Get id
					HTMLEditor(id, curJson[id].title, function(d) {				// Edit text
						curJson[id].title=d;									// Set val
						MakeMobTable();											// Show
						});
					});				

			$("#iddh"+i).on("click", function() {								// HTML EDITOR
					var id=this.id.substr(4);									// Get id
					HTMLEditor(id, curJson[id].desc, function(d) {				// Edit text
						curJson[id].desc=d;										// Set val
						MakeMobTable();											// Show
						});
					});				

			$("#idg"+i).on("click", function() {								// GOTO EDITOR
					var id=this.id.substr(3);									// Get id
					GoToEditor(id, curJson[id].goto, function(w) {				// Edit source
						curJson[id].goto=w;										// Set val
						MakeMobTable();											// Show
						});
					});				

			$("#idm"+i).on("click", function() {								// MORE EDITOR
					var id=this.id.substr(3);									// Get id
					MoreEditor(id) 												// Edit more settings
					});				
	
			$("#idt"+i).on("blur", function() {									// ON BLUR OF TITLE
					var id=this.id.substr(3);									// Get id
					curJson[id].title=$("#idt"+id).val();						// Get text
					MakeMobTable();												// Remake table
					});				
	
			$("#idd"+i).on("blur", function() {									// ON BLUR OF TITLE
					var id=this.id.substr(3);									// Get id
					curJson[id].desc=$("#idd"+id).val();						// Get text
					MakeMobTable();												// Remake table
					});				

			$("#ida"+i).on("change", function() {								// ON EDIT TYPE
					var id=this.id.substr(3);									// Get id
					curJson[id].type=$("#ida"+id).val();						// Get text
					MakeMobTable();												// Remake table
					});				
			}																	// End mob loop
	}	

	function onDeleteMob(id) 												// ON DELETE MOB
	{	
		id=id.substr(4);														// Strip off prefix
		var type=curJson[id].type;												// Get type
		curJson.splice(id,1);													// Remove from json
		$("#idx"+id).remove();													// Remove from table
		Sound("delete");														// Delete sound
		if (type == "page")														// If a page
			MakePageTable();													// Redraw page table
		else																	// A mob	
			MakeMobTable();														// Redraw mob table
		}

	function onMoveMob(id, to) 												// ON MOVE MOB
	{	
		var type=curJson[id].type;												// Get type
		curJson.splice(to,0,curJson.splice(id,1)[0]);							// Move		
		if (type == "page")														// If a page
			MakePageTable();													// Redraw page table
		else																	// A mob	
			MakeMobTable();														// Redraw mob table
	}

	function HTMLEditor(id, text, callback) 								// GOTO EDITOR
	{	
		$("#alertBoxDiv").remove();												// Remove any old ones
		if (!text)	text="";													// Not defined
		$("body").append("<div style='overflow:hidden;' class='unselectable' id='alertBoxDiv'></div>");														
		var str="<p><img src='images/qlogo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";								
		str+="<span style='font-size:18px;text-shadow:1px 1px #ccc;color:#000000'><b>Style text</b></span><br><br><p><table>";
 		str+="<textarea id='editor1' rows='4' style='width:100%' >"+text+"</textarea>";
 		$("#alertBoxDiv").append("</div>"+str);	
 		CKEDITOR.replace('editor1');
   		
  		$("#alertBoxDiv").dialog({ width:580, buttons: {
	    	"OK": 		function() { 
	    					var s=CKEDITOR.instances.editor1.getData().replace(/[\n|\r]/g,"").replace(/"/g,"&quot;");
	    					callback(s);										// Send to callback	
		    				$(this).remove();									// Remove dialog
		    				},
		    "Cancel": 	function() { $(this).remove(); }
			}});	
		$("#alertBoxDiv").dialog("option","position",{ my:"center", at:"center", of:"#paneDiv" });
		$(".ui-dialog-titlebar").hide();
		$(".ui-dialog-buttonpane.ui-widget-content.ui-helper-clearfix").css("border","none");
		$(".ui-dialog").css({"border-radius":"14px", "box-shadow":"4px 4px 8px #ccc"});
 		$(".ui-button").css({"border-radius":"30px","outline":"none"});
 	}


	function GoToEditor(id, where, callback) 								// GOTO EDITOR
	{	
		$("#alertBoxDiv").remove();												// Remove any old ones
		$("body").append("<div style='overflow:hidden;' class='unselectable' id='alertBoxDiv'></div>");														
		var str="<p><img src='images/qlogo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";								
		str+="<span style='font-size:18px;text-shadow:1px 1px #ccc;color:#000000'><b>Set goto position</b></span><br><br><p><table>";
     	str+="<tr><td>Lat: </td><td><input id='gotolat' class='is' style='width:100px'>";
  	 	str+="<td> Long: </td><td><input id='gotolon' class='is' style='width:100px'></td>";
  	 	str+="<td> Range: </td><td><input id='gotohgt' class='is' style='width:100px'></tr>";
    	str+="<tr><td>Tilt: </td><td><input id='gototlt' class='is' style='width:100px'>";
  	 	str+="<td> Rotate: </td><td><input id='gotohdg' class='is' style='width:100px'></td>";
  	 	str+="<td> Speed: </td><td><input id='gotospd' class='is' style='width:100px'></tr>";
 		str+="</table>";		
		str+="<br><b>How to set a goto position:</b><br><br>Position the earth on the left where you want to go to. Click on the <i>OK</i> button to save, or the <i>Remove goto button</i> to remove the goto entirely. You can also use the MapScholar shelf items or the <i>Find</i> option to navigate. You can change the default speed of the move by entering a value in the speed box. The speed is from 0 (forever) to 5 (instantly) and is optional. The default is 1, which takes approximately 2 seconds. " 
		$("#alertBoxDiv").append("</div>"+str);	

		if (!where)																// If no pos set
			where=curPos;														// Use current pos
		var v=where.split(",");													// Split
		$("#gotolat").val(v[0]);												// Set lat field
		$("#gotolon").val(v[1]);												// Set lon field
		$("#gotohgt").val(v[2]);												// Set hgt field
		$("#gototlt").val(v[3]);												// Set tilt field
		$("#gotohdg").val(v[4]);												// Set heading field
		if (v[5] != undefined)													// If a speed set
			$("#gotospd").val(v[5]);											// Set speed field,
					
		$("#alertBoxDiv").dialog({ width:500, buttons: {
	    	"OK": 			function() { 
	    						where="";										// Normal move
	    						where+=$("#gotolat").val()+",";					// Add lat
	    						where+=$("#gotolon").val()+",";					// Lon
	    						where+=$("#gotohgt").val()+",";					// Hgt
	    						where+=$("#gototlt").val()+",";  				// Tilt
	    						where+=$("#gotohdg").val();						// Heading
								if ($("#gotospd").val())						// If a speed set
		    						where+=","+$("#gotospd").val();				// Add it
	    						callback(where);								// Send to callback	
	    						$(this).remove();								// Remove dialog
	    						},
	    	"Remove goto": 	function() { callback("");			$(this).remove();	},
	    	"Cancel":  		function() { $(this).remove(); 							}
			}});	
		$("#alertBoxDiv").dialog("option","position",{ my:"center", at:"center", of:"#paneDiv" });
		$(".ui-dialog-titlebar").hide();
		$(".ui-dialog-buttonpane.ui-widget-content.ui-helper-clearfix").css("border","none");
		$(".ui-dialog").css({"border-radius":"14px", "box-shadow":"4px 4px 8px #ccc"});
 		$(".ui-button").css({"border-radius":"30px","outline":"none"});
	}

	function MoreEditor(id) 												// MORE EDITOR
	{	
		$("#alertBoxDiv").remove();												// Remove any old ones
		$("body").append("<div style='overflow:hidden;' class='unselectable' id='alertBoxDiv'></div>");														
		var str="<p><img src='images/qlogo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";								
		str+="<span style='font-size:18px;text-shadow:1px 1px #ccc;color:#000000'><b>Mob settings</b></span><br><br><p><table>";
     	str+="<tr><td>Start date: </td><td><input id='sdate' class='is' style='width:40px'>";
  	 	str+="&nbsp; End Date: <input id='edate' class='is' style='width:40px'>";
   	 	str+="&nbsp; Mob ID: <input id='mobid' class='is' style='width:30px'></td></tr>";
	 	str+="<tr><td>Citation: </td><td><input id='cite' class='is' style='width:270px'> ";
  	 	str+="<img src='img/editdot.gif' id='citeh'></td></tr>";
	 	str+="<tr><td>Prompt: </td><td><input id='prompt' class='is' style='width:270px'> ";
  	 	str+="<img src='img/editdot.gif' id='prompth'></td></tr>";
     	str+="<tr><td>North: </td><td><input id='north' class='is' style='width:40px'>";
  	 	str+="&nbsp; South: <input id='south' class='is' style='width:40px'>"
		str+=" &nbsp; <button class='bs' style='color:#009900;background-color:#fff' id='rectify'>Geo - reference</button></td></tr>";
  	 	str+="<tr><td>East: </td><td><input id='east' class='is' style='width:40px'>";
     	str+="&nbsp; West: &nbsp;<input id='west' class='is' style='width:40px'>";
     	str+="&nbsp; Rotation: <input id='rotation' class='is' style='width:40px'></td></tr>";
  	 	str+="<tr><td>Settings: </td><td><input id='settings' class='is' style='width:40px'>";
     	str+="&nbsp; Base: &nbsp;<input id='base' class='is' style='width:40px'>";
     	str+="&nbsp; Status: &nbsp;&nbsp; <input id='status' class='is' style='width:40px'></td></tr>";
 	 	str+="<tr><td>Small pic: </td><td><input id='small' class='is' style='width:92px'>";
     	str+="&nbsp; Med pic: &nbsp;<input id='med' class='is' style='width:94px'></td></tr>";
  		str+="<tr><td>Orig/url: </td><td><input id='url' class='is' style='width:200px'>&nbsp; ";
  		str+="<img src='images/flickrbut.png' id='flickr' style='vertical-align:-4px'></td></tr>";
   		str+="</table>";		
		str+="<br><b>Settings:</b><br><br>Help goes here";
			$("#alertBoxDiv").append(""+str);	
		var o=curJson[id];														// Point at mob
		
		if (o.start)															// If set
			$("#sdate").val(o.start);											// Set start
		if (o.end)																// If set
			$("#edate").val(o.end);												// Set end
		if (o.id != undefined)													// If set
			$("#mobid").val(o.id);												// Set end
		if (o.citation != undefined)											// If set
			$("#cite").val(o.citation);											// Set end
		if (o.prompt != undefined)												// If set
			$("#prompt").val(o.prompt);											// Set end
		if (o.north != undefined)												// If set
			$("#north").val(o.north);											// Set end
		if (o.south != undefined)												// If set
			$("#south").val(o.south);											// Set end
		if (o.east != undefined)												// If set
			$("#east").val(o.east);												// Set end
		if (o.west != undefined)												// If set
			$("#west").val(o.west);												// Set end
		if (o.rotation != undefined)											// If set
			$("#rotation").val(o.rotation);										// Set end
		if (o.status != undefined)												// If set
			$("#status").val(o.status);											// Set end
		if (o.base != undefined)												// If set
			$("#base").val(o.base);												// Set end
		if (o.settings != undefined)											// If set
			$("#settings").val(o.settings);										// Set end
		if (o.small != undefined)												// If set
			$("#small").val(o.small);											// Set end
		if (o.med != undefined)													// If set
			$("#med").val(o.med);												// Set end
		if (o.url != undefined)													// If set
			$("#url").val(o.url);												// Set end
						
		$("#alertBoxDiv").dialog({ width:405, buttons: {
	    	"OK": 			function() { 
								o.start=$("#sdate").val();						// Set val
								o.end=$("#edate").val();						// Set val
								o.id=$("#mobid").val();							// Set val
								o.citation=$("#cite").val();					// Set val
								o.prompt=$("#prompt").val();					// Set val
								o.north=$("#north").val();						// Set val
								o.south=$("#south").val();						// Set val
								o.east=$("#east").val();						// Set val
								o.west=$("#west").val();						// Set val
								o.rotation=$("#rotation").val();				// Set val
								o.status=$("#status").val();					// Set val
								o.base=$("#base").val();						// Set val
								o.settings=$("#settings").val();				// Set val
								o.small=$("#small").val();						// Set val
								o.med=$("#med").val();							// Set val
								o.url=$("#url").val();							// Set val
								MakeMobTable();									// Show
		    					$(this).remove();								// Remove dialog
								SendShivaMessage("MapEdit=rectify","allDone");	// Done rectifying	   		
	    						},
	    	"Cancel":  		function() { 
		    					$(this).remove();								// Remove dialog
								SendShivaMessage("MapEdit=rectify","allDone");	// Done rectifying	   		
	    						}
			}});	
	
		$("#alertBoxDiv").dialog("option","position",{ my:"center", at:"center", of:"#paneDiv" });
		$(".ui-dialog-titlebar").hide();
		$(".ui-dialog-buttonpane.ui-widget-content.ui-helper-clearfix").css("border","none");
		$(".ui-dialog").css({"border-radius":"14px", "box-shadow":"4px 4px 8px #ccc"});
 		$(".ui-button").css({"border-radius":"30px","outline":"none"});

		$("#citeh").on("click", function() {									// HTML EDITOR
				HTMLEditor(id, curJson[id].citation, function(d) {				// Edit text
					curJson[id].citation=d;										// Set val
					});
				});				
		$("#prompth").on("click", function() {									// HTML EDITOR
				HTMLEditor(id, curJson[id].prompt, function(d) {				// Edit text
					curJson[id].prompt=d;										// Set val
					});
				});				

		$("#rectify").on("click", function() {									// RECTIFY PIC
				str=($("#small").val()  ? $("#small").val() : "") +"|";			// Send small img
				str+=($("#med").val()   ? $("#med").val() 	: "") +"|";			// Send med img
				str+=($("#url").val()   ? $("#url").val() 	: "") +"|";			// Send orig img
				str+=($("#north").val() ? $("#north").val() : "") +"|";			// Send N
				str+=($("#south").val() ? $("#south").val() : "") +"|";			// Send S
				str+=($("#east").val()  ? $("#east").val()  : "") +"|";			// Send E
				str+=($("#west").val()  ? $("#west").val()  : "") +"|";			// Send W
				str+=($("#rotation").val() != undefined ? $("#rotation").val() : "") +"|"; // Send R
				str+=id;														// Add id
				SendShivaMessage("MapEdit=rectify",str);						// Send to show player	   		
				});				

		$("#flickr").on("click", function() {									// GET PIX FROM FLICKR
				GetFlickrImage( function(s) { 									// Flickr editor
					if (s) {													// If something
						var v=s.split("\t");									// Split into files
						var n=v.length-1;										// Get num of files
						if (v[n-1])		curJson[id].url=v[n-1];					// Set url using last
						if (v[n-2])		curJson[id].med=v[n-2];					// Set med using last-1
						if (v[n-3])		curJson[id].small=v[n-3];				// Set med using last-2
						}
					MoreEditor(id);												// Show more editor again
					}, true );
				});				

	}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// EVENTS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	
	function shivaEventHandler(e)											// ON SHIVA EVENT
	{
//		trace(e.data);
		if (e.data.match(/MapScholar=resize/))	{								// If a resize
			playerWid=(e.data.split("|")[2]-0+20);								// Isolate it
			Draw();																// Redraw
			}
		else if (e.data.match(/ShivaEarth=move/))	{							// If a move
			var v=e.data.split("|");											// Split
			$("#gotolat").val(v[2]);											// Set lat field, if open
			$("#gotolon").val(v[3]);											// Set lon field, if open
			$("#gotohgt").val(v[4]);											// Set hgt field, if open
			$("#gototlt").val(v[5]);											// Set tilt field, if open
			$("#gotohdg").val(v[6]);											// Set heading field, if open
			curPos=v[2]+","+v[3]+","+v[4]+","+v[5]+","+v[6];					// Make up goto
			}	
		else if (e.data.match(/MapScholar=mob/))								// If mob clicked
			HighlightMob(e.data.split("|")[2]);									// Highlight mob entry
		else if (e.data.match(/MapScholar=rectify/))	{						// If rectifying
			var v=e.data.split("|");											// Split
			$("#north").val(v[2]);												// Set north field, if open
			$("#south").val(v[3]);												// Set south field, if open
			$("#east").val(v[4]);												// Set east field, if open
			$("#west").val(v[5]);												// Set west field, if open
			$("#rotation").val(v[6]);											// Set rotation field, if open
			}
	}

	function HighlightMob(id) 												// HIGHLIGHT MOB IN LIST
	{
		var i;
		for (i=0;i<curJson.length;++i)  										// For each mob in project
			$("#idx"+i).css("backgroundColor","#f8f8f8");						// Clear all
		for (i=0;i<curJson.length;++i) { 										// For each mob
			if (curJson[i].id == id) {											// If ids match
				curEdit=id;														// Set curEdit
				id=$("#mobList").scrollTop()+$("#idx"+i).position().top-$("#mobList").offset().top+9;	// Calc scroll
				$("#mobList").scrollTop(id);									// Set scroll
				$("#idx"+i).css("backgroundColor","#dee7f1");					// Color current one
				break;															// Quit looking
				}
			}
	}
		
	function SendShivaMessage(cmd, msg) 									// SEND SHIVA MESSAGE 
	{
		var str=cmd;															// Add src					
		if (msg)																// If more to it
			str+="|"+msg;														// Add it
		var win=document.getElementById("playerIF").contentWindow;				// Point at iframe	
		win.postMessage(str,"*");												// Send message to show
	}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function MakeSelect(id, multi, items, sel, extra, values)				// CREATE SELECT WIDGET
	{
		var	str="<select class='bs' id='"+id+"'";
		if (multi)
			str+="multiple='multiple' size='"+multi+"'";
		if (extra)
			str+=extra;
		str+=">";
		for (i=0;i<items.length;++i) {
			str+="<option";
			if (sel == items[i])
				str+=" selected='selected'"
			if (values && values[i])
				str+=" value='"+values[i]+"'";
			str+=">"+items[i]+"</option>";
			}	
		return str+"</select>"
	}
	
	
</script>
</body></html>